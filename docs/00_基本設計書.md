# 草野球対戦履歴アプリ 基本設計書

**目的**：草野球における バッター×ピッチャー および チーム×チーム の対戦履歴を蓄積し、因縁（相性）を「見せたくなるカード」として共有できるプロダクトを実現する。

---

## 1. プロダクト概要

### 1.1 コンセプト

- 草野球版・対戦履歴メディア
- 片側（自分だけ）の入力でも成立し、相手が後から参加して「名寄せ／本人化」されることで価値が増す（ネットワーク効果）

### 1.2 提供価値

- **個人**：
  - 自分の打撃/投球成績の整理
  - 特定投手/打者との相性が見える
- **チーム**：
  - チームの対戦史（宿敵、通算戦績、最近の流れ）
- **共有**：
  - 因縁カード（SNS/LINE向け画像）で拡散しやすい

### 1.3 主要KPI（目安）

- 初回価値到達：初回登録〜「因縁カード生成」まで 3分以内
- 継続：月1回以上の試合記録率
- 招待：カード共有→相手の新規登録率

---

## 2. スコープ

### 2.1 MVP（最初に作る範囲）

- 認証（Firebase Auth）
- チーム作成/参加（招待コード）
- 試合作成
- 打席イベント入力（簡易）
- バッター×ピッチャー対戦成績の自動集計
- 因縁カード生成（テキスト＋スコア＋相性）
- 共有（画像/リンク）
- 相手未登録でも保存（仮プレイヤー/仮チーム）
- 名寄せ（相手が登録後にClaim）

### 2.2 将来拡張（MVP外）

- 動画/写真からハイライト抽出
- OCRでスコアブック取り込み
- 公式リーグ機能（大会運営者向け）
- 詳細スタッツ（球種、コース、打球方向など）

---

## 3. ユースケース

### 3.1 代表ユーザー

- **記録係**（キャプテン/マネージャー）：入力担当
- **選手**：閲覧・共有担当

### 3.2 ユースケース一覧

1. ユーザー登録/ログイン
2. チーム作成
3. チーム参加（招待コード）
4. 試合作成（対戦相手は仮でも可）
5. 打席入力（バッター・ピッチャー・結果）
6. 自動集計（対戦成績、通算、直近）
7. 因縁カード生成
8. 共有（画像/リンク）
9. 相手のClaim（本人化）
10. 異議申し立て/修正フロー（最小限）

---

## 4. 機能要件

### 4.1 認証・アカウント

- **Firebase Authentication**
  - Email/Password（MVP）
  - Apple/Google（優先度高：後続）
- **ユーザープロフィール**
  - 表示名（必須）
  - 野球利き腕、ポジション（任意）
  - アイコン（任意）

### 4.2 チーム

- **チーム作成**
  - チーム名（必須）
  - 都道府県/活動エリア（任意）
  - アイコン（任意）
- **招待コード発行**
- **参加申請 or 即時参加**（MVPは即時）
- **メンバー管理（ロール）**
  - Owner（作成者）
  - Admin（記録編集可）
  - Member（閲覧＋共有）

### 4.3 試合

- **試合作成**
  - 日時
  - 球場（任意）
  - 自チーム（必須）
  - 相手チーム（選択：登録済 or 仮チーム作成）
- **試合状態**
  - Draft（作成中）
  - Final（確定）

### 4.4 打席イベント（MVP簡易）

- 1打席 = 1イベントとして入力
- **入力項目**
  - イニング（任意）
  - バッター（登録済 or 仮プレイヤー）
  - ピッチャー（登録済 or 仮プレイヤー）
  - 結果（必須）
    - OUT（ゴロ/フライ/三振/併殺/…）
    - HIT（単打/二塁打/三塁打/本塁打）
    - WALK（四球/死球）
    - ERROR
  - 打点（任意）
- **集計対象（MVP）**
  - 打数、安打、HR、四死球、三振、出塁率（簡易）

### 4.5 対戦成績（因縁）

- **バッター×ピッチャー**
  - 通算：打数/安打/HR/四死球/三振
  - 直近N試合（N=3/5）
  - 相性指標（例：打率、OPS簡易）
- **チーム×チーム**
  - 通算：勝敗/得点/失点
  - 直近N試合

### 4.6 因縁カード生成・共有

- **カード種類**
  - 個人因縁（Batter vs Pitcher）
  - チーム因縁（Team vs Team）
- **生成内容**
  - タイトル（テンプレ＋AIオプション）
  - 通算成績
  - 直近成績
  - 一言コメント（テンプレ or AI）
- **出力**
  - 画像（端末側でレンダリング→共有）
  - Webリンク（将来：Dynamic Links/Universal Links）

### 4.7 仮プレイヤー／名寄せ（Claim）

- **仮プレイヤー**
  - 未登録の相手選手を入力するための器
  - 表示名のみ必須（「◯◯クラブ 右腕エース」等）
- **Claim**
  - 仮プレイヤーに「本人」が紐づく
  - 以後、対戦履歴が本人プロフィールに統合表示

### 4.8 修正・異議申し立て（MVP最小）

- 試合の編集権限：Owner/Admin
- 申し立て：Memberが「修正依頼」送信（通知は後続）
- MVPは「編集履歴（監査ログ）」のみ実装し、ワークフローは簡易

---

## 5. 画面設計（情報設計）

### 5.1 画面一覧

1. **認証**
   - Login
   - SignUp
2. **ホーム**
   - 直近試合
   - 因縁カード（おすすめ）
3. **チーム**
   - チーム詳細
   - メンバー一覧
   - 招待コード
4. **試合**
   - 試合一覧
   - 試合詳細（イベント一覧）
   - 打席入力
5. **因縁**
   - 因縁一覧（個人/チーム切替）
   - 因縁詳細
   - 因縁カード生成・共有
6. **プロフィール**
   - 自分
   - プレイヤー（他者/仮含む）
7. **設定**

### 5.2 画面遷移（概要）

- Home → 試合詳細 → 打席入力
- Home → 因縁一覧 → 因縁詳細 → カード生成 → 共有
- チーム詳細 → 招待コード → 参加

### 5.3 因縁詳細の情報設計

- ヘッダー：対戦者（Batter/Pitcher or Team/Team）
- 通算
- 直近N
- 主な結果（HR、三振など）
- 共有CTA：カード生成

---

## 6. データ設計（Supabase / Postgres）

**方針**：イベントソーシング寄り（打席イベントが一次データ）

集計は Materialized View / SQL View / Edge Function / バックグラウンド集計のいずれか。
MVPは「SQL View + 必要に応じてキャッシュテーブル」推奨。

### 6.1 ID方針

- uuid（Postgres `gen_random_uuid()`）
- Firebase Auth uid を `users.firebase_uid` に保持

### 6.2 テーブル一覧

#### users

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| firebase_uid | text | unique not null |
| display_name | text | not null |
| photo_url | text | null |
| created_at | timestamptz | not null default now() |

#### teams

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| name | text | not null |
| area | text | null |
| photo_url | text | null |
| invite_code | text | unique not null |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

#### team_members

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| team_id | uuid | not null references teams(id) |
| user_id | uuid | not null references users(id) |
| role | text | not null ('owner'\|'admin'\|'member') |
| created_at | timestamptz | not null default now() |

※ unique (team_id, user_id)

#### players

プレイヤーは「ユーザー本人」または「仮プレイヤー」

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| team_id | uuid | null references teams(id) - 所属不明/仮もあり得る |
| display_name | text | not null |
| user_id | uuid | null references users(id) - nullなら仮 |
| created_by | uuid | not null references users(id) - 仮を作った人 |
| created_at | timestamptz | not null default now() |

#### games

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| date | date | not null |
| location | text | null |
| home_team_id | uuid | not null references teams(id) |
| away_team_id | uuid | not null references teams(id) - 仮チーム対応するなら別途 opponent_teams |
| home_score | int | null |
| away_score | int | null |
| status | text | not null default 'draft' ('draft'\|'final') |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

#### plate_appearances

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| game_id | uuid | not null references games(id) |
| inning | int | null |
| batter_player_id | uuid | not null references players(id) |
| pitcher_player_id | uuid | not null references players(id) |
| result_type | text | not null ('out'\|'hit'\|'walk'\|'error') |
| result_detail | text | not null ('single'\|'double'\|'triple'\|'hr'\|'k'\|'fly'… etc) |
| rbi | int | null |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

#### claims

仮プレイヤーの本人化

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| player_id | uuid | not null references players(id) |
| claimed_user_id | uuid | not null references users(id) |
| status | text | not null default 'approved' - MVPは即時。将来 'pending'\|'approved'\|'rejected' |
| created_at | timestamptz | not null default now() |

#### audit_logs

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| actor_user_id | uuid | not null references users(id) |
| entity_type | text | not null ('game'\|'plate_appearance'\|'player'…) |
| entity_id | uuid | not null |
| action | text | not null ('create'\|'update'\|'delete') |
| payload | jsonb | not null |
| created_at | timestamptz | not null default now() |

### 6.3 ビュー（集計）

#### v_matchup_batter_pitcher

- 粒度：batter_player_id × pitcher_player_id
- 指標：
  - ab（打数）, h（安打）, hr, bb_hbp, so, avg
  - last_n は別ビュー or クエリ（order by game.date desc limit N）

#### v_matchup_team_team

- 粒度：home_team_id × away_team_id（対称性のため正規化キー推奨：小さいuuidをA側に）
- 指標：
  - games, wins, losses, runs_for, runs_against

**注：対称性の正規化キー**

```sql
team_a = least(home_team_id, away_team_id)
team_b = greatest(home_team_id, away_team_id)
```

### 6.4 RLS（Row Level Security）方針（MVP）

- **teams/team_members**: 所属ユーザーのみ参照
- **games/plate_appearances**: 試合の home/away のいずれかのチームに所属するユーザーのみ参照
- **players**:
  - 自チーム所属の players は参照可能
  - opponent の仮プレイヤーは「該当試合に関与する場合のみ参照」
- **claims**: 当事者のみ参照

---

## 7. Firebase 設計

### 7.1 Firebase Auth

- 認証のみ Firebase
- サーバー側（Supabase）で Firebase JWT を検証して users と紐づけ

### 7.2 Firebase Dynamic Links（将来）

- 因縁カード/試合ページの共有URL
- 未インストール時はストアへ誘導

### 7.3 Firebase Cloud Messaging（将来）

- Claim通知
- 修正依頼

---

## 8. アーキテクチャ（Flutter / MVVM + Clean Architecture）

### 8.1 レイヤ構成

- **Presentation**
  - View（Widget）
  - ViewModel（State管理）
- **Domain**
  - Entity
  - UseCase
  - Repository Interface
- **Data**
  - Repository Impl
  - DataSource（Supabase/Firebase）
  - DTO/Mapper

### 8.2 ディレクトリ例

```
lib/
  core/
    error/
    network/
    routing/
    theme/
    utils/
  features/
    auth/
      presentation/
      domain/
      data/
    teams/
    games/
    matchups/
    profile/
    share/
  main.dart
```

### 8.3 状態管理（推奨）

- Riverpod もしくは Bloc（どちらでも）
- ViewModelは AsyncValue / StateNotifier で管理

### 8.4 依存関係

- Domain は Flutter/Firebase/Supabase に依存しない
- Data が外部依存を吸収

### 8.5 主要UseCase例

- SignInUseCase
- CreateTeamUseCase
- JoinTeamUseCase
- CreateGameUseCase
- AddPlateAppearanceUseCase
- GetMatchupUseCase
- GenerateRivalryCardUseCase
- ClaimPlayerUseCase

---

## 9. 因縁カード生成（実装設計）

### 9.1 カード生成フロー

1. ViewModel が集計データ取得（matchup view）
2. テンプレートを選択
3. 端末内でCanvas描画（Flutter）
4. 画像化（png）
5. Share sheet で共有

### 9.2 テキスト生成（AIオプション）

- MVP：テンプレ文
- 将来：Edge Function で LLM 呼び出し
  - 入力：通算/直近/特筆（HR, SO）
  - 出力：タイトル・一言

**注意**：AI文章は正確性より「盛り上がり」。誹謗中傷にならないフィルタを用意。

---

## 10. 名寄せ（Claim）詳細

### 10.1 Claim対象

- `players.user_id is null` の仮プレイヤー

### 10.2 Claim手段（MVP案）

- 自分の名前が含まれるプレイヤー候補一覧から選ぶ
- 該当試合に参加したユーザーのみ Claim 可能（RLSで制限）

### 10.3 Claim後の表示

- `players.user_id` に紐づけ
- 以後、プロフィール画面で「あなたの対戦史」として表示

---

## 11. 非機能要件

### 11.1 パフォーマンス

- 試合詳細：イベント100件程度を想定
- 因縁一覧：ページング必須
- 集計ビューはDB側で実施

### 11.2 データ整合性

- 打席イベントが一次データ
- ゲーム確定（final）後の編集は Admin のみに制限（将来：ロック＋申請）

### 11.3 セキュリティ

- RLS適用
- 共有リンクは閲覧のみ（将来）
- 個人情報は最小（メール/表示名のみ）

### 11.4 障害時

- 監査ログ（audit_logs）
- リカバリ：plate_appearances を正として再集計可能

---

## 12. リリース計画（MVP）

### 12.1 マイルストーン

- **M1**：認証 + チーム + 試合CRUD
- **M2**：打席入力 + 集計ビュー
- **M3**：因縁詳細 + カード生成 + 共有
- **M4**：仮プレイヤー + Claim
- **M5**：βテスト（1〜3チーム）→改善

### 12.2 βテスト観点

- 入力が重くないか（試合後5分で終わるか）
- 因縁カードが「見せたくなる」か
- 相手が登録したくなる導線があるか

---

## 13. 仕様メモ（重要な判断）

### 13.1 入力設計の割り切り

- MVPでは「打席イベント」だけを正確に。
- 守備や走塁などは捨てる。

### 13.2 初期ネットワーク問題の回避

- 相手未登録でも仮で入力可能。
- 相手が後から Claim できる。

### 13.3 バズ導線

- 因縁カードは 共有前提UI（1タップで画像生成→共有）。
- 小さな透かし（アプリ名）を入れる（課金でOFF）。

---

## 付録A：結果コード（MVP）

| result_type | result_detail |
|-------------|---------------|
| hit | single, double, triple, hr |
| out | k, ground, fly, line, dp, other |
| walk | bb, hbp |
| error | e |

---

## 付録B：集計定義（MVP）

| 指標 | 定義 |
|------|------|
| AB（打数） | result_type in ('hit','out','error') ※errorはABに含める運用 |
| H（安打） | result_type='hit' |
| HR | result_detail='hr' |
| BB/HBP | result_type='walk' |
| SO | result_detail='k' |
| AVG | H / AB（AB>0） |

---

## 次に詰める項目（設計を固めるため）

1. 「プレイヤーはチームに固定か？」（移籍/助っ人対応）
2. 相手チームを仮で作るか、ゲームに opponent_name を持たせるか
3. Claimの本人確認（MVPは弱くてOK、悪用耐性をどうするか）
