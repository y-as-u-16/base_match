# テーブル設計書（Supabase / Postgres）

**方針**：イベントソーシング寄り（打席イベントが一次データ）

集計は Materialized View / SQL View / Edge Function / バックグラウンド集計のいずれか。
MVPは「SQL View + 必要に応じてキャッシュテーブル」推奨。

---

## 1. ID方針

- uuid（Postgres `gen_random_uuid()`）
- Firebase Auth uid を `users.firebase_uid` に保持

---

## 2. テーブル一覧

### users

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| firebase_uid | text | unique not null |
| display_name | text | not null |
| photo_url | text | null |
| created_at | timestamptz | not null default now() |

### teams

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| name | text | not null |
| area | text | null |
| photo_url | text | null |
| invite_code | text | unique not null |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

### team_members

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| team_id | uuid | not null references teams(id) |
| user_id | uuid | not null references users(id) |
| role | text | not null ('owner'\|'admin'\|'member') |
| created_at | timestamptz | not null default now() |

※ unique (team_id, user_id)

### players

プレイヤーは「ユーザー本人」または「仮プレイヤー」

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| team_id | uuid | null references teams(id) - 所属不明/仮もあり得る |
| display_name | text | not null |
| user_id | uuid | null references users(id) - nullなら仮 |
| created_by | uuid | not null references users(id) - 仮を作った人 |
| created_at | timestamptz | not null default now() |

### games

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| date | date | not null |
| location | text | null |
| home_team_id | uuid | not null references teams(id) |
| away_team_id | uuid | not null references teams(id) - 仮チーム対応するなら別途 opponent_teams |
| home_score | int | null |
| away_score | int | null |
| status | text | not null default 'draft' ('draft'\|'final') |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

### plate_appearances

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| game_id | uuid | not null references games(id) |
| inning | int | null |
| batter_player_id | uuid | not null references players(id) |
| pitcher_player_id | uuid | not null references players(id) |
| result_type | text | not null ('out'\|'hit'\|'walk'\|'error') |
| result_detail | text | not null ('single'\|'double'\|'triple'\|'hr'\|'k'\|'fly'… etc) |
| rbi | int | null |
| created_by | uuid | not null references users(id) |
| created_at | timestamptz | not null default now() |

### claims

仮プレイヤーの本人化

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| player_id | uuid | not null references players(id) |
| claimed_user_id | uuid | not null references users(id) |
| status | text | not null default 'approved' - MVPは即時。将来 'pending'\|'approved'\|'rejected' |
| created_at | timestamptz | not null default now() |

### audit_logs

| カラム | 型 | 備考 |
|--------|-----|------|
| id | uuid | pk |
| actor_user_id | uuid | not null references users(id) |
| entity_type | text | not null ('game'\|'plate_appearance'\|'player'…) |
| entity_id | uuid | not null |
| action | text | not null ('create'\|'update'\|'delete') |
| payload | jsonb | not null |
| created_at | timestamptz | not null default now() |

---

## 3. ビュー（集計）

### v_matchup_batter_pitcher

- 粒度：batter_player_id × pitcher_player_id
- 指標：
  - ab（打数）, h（安打）, hr, bb_hbp, so, avg
  - last_n は別ビュー or クエリ（order by game.date desc limit N）

### v_matchup_team_team

- 粒度：home_team_id × away_team_id（対称性のため正規化キー推奨：小さいuuidをA側に）
- 指標：
  - games, wins, losses, runs_for, runs_against

**注：対称性の正規化キー**

```sql
team_a = least(home_team_id, away_team_id)
team_b = greatest(home_team_id, away_team_id)
```

---

## 4. RLS（Row Level Security）方針（MVP）

- **teams/team_members**: 所属ユーザーのみ参照
- **games/plate_appearances**: 試合の home/away のいずれかのチームに所属するユーザーのみ参照
- **players**:
  - 自チーム所属の players は参照可能
  - opponent の仮プレイヤーは「該当試合に関与する場合のみ参照」
- **claims**: 当事者のみ参照

---

## 付録A：結果コード（MVP）

| result_type | result_detail |
|-------------|---------------|
| hit | single, double, triple, hr |
| out | k, ground, fly, line, dp, other |
| walk | bb, hbp |
| error | e |

---

## 付録B：集計定義（MVP）

| 指標 | 定義 |
|------|------|
| AB（打数） | result_type in ('hit','out','error') ※errorはABに含める運用 |
| H（安打） | result_type='hit' |
| HR | result_detail='hr' |
| BB/HBP | result_type='walk' |
| SO | result_detail='k' |
| AVG | H / AB（AB>0） |
